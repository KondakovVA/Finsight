# Finsight

Finsight — это решение для автоматизации цикла работы заказов в коммерческой компании. Проект состоит из ASP.NET Core Web API и десктопного клиента на WPF.

## Возможности

- **Управление пользователями.** API поддерживает регистрацию, обновление и удаление сотрудников, контролируя уникальность логинов и очищая назначенные заказы при удалении исполнителя. При первом входе автоматически создаётся административная учётная запись, если в системе ещё нет пользователей.
- **Работа с клиентами.** Сервис позволяет вести карточки компаний, редактировать данные и удалять записи с валидацией существования в базе данных.
- **Заказы и документы.** Бизнес-логика создаёт, обновляет и возвращает заказы вместе с данными клиента и исполнителя, а также удаляет записи с проверкой наличия. Отдельный сервис валидирует список файлов, проверяет расширения и сохраняет документы в каталоге пользователя.
- **Настольный интерфейс.** Клиентское приложение предоставляет модули «Клиенты», «Заказы», «Сотрудники», «Финансы», «Аналитика» и домашний экран. После авторизации меню строится по ролям, а сценарий заказов использует карточки с загрузкой документов и повторным использованием репозиториев HTTP.
- **Аутентификация и сессии.** Пользователи проходят авторизацию через форму входа WPF, после чего токен и данные пользователя сохраняются в сессии клиента для вызовов API; для отладки можно включить автоматический вход через конфигурацию. Issuer и Audience для JWT-аутентификации отключены, но все данные передаются, достаточно сменить флаги на true.

## Архитектура решения

```
Finsight.sln
├── Finsight.WebApi      — REST API, JWT-аутентификация, загрузка документов, Swagger, NLog
├── Finsight.Core        — бизнес-логика, EF Core, миграции, мапперы и DAO-абстракции
├── Finsight.Contract    — DTO, перечисления и общие интерфейсы для клиента и сервера
└── Finsight.Client      — WPF-приложение на .NET 9 с Flurl.Http, Unity DI и модулями UI
```

- **Слой Core** регистрирует DAO и BL через `AddCore`, предоставляя EF Core `DbContext` и обёртки DAO для сущностей пользователей, клиентов и заказов.
- **WebApi** расширяет DI контейнер сервисами JWT и OrderDocument, валидирует конфигурацию и применяет миграции при запуске, включая Swagger в режиме разработки.
- **Клиент** использует глобальную регистрацию Flurl HTTP клиента и построение главного окна через Unity-контейнер, обрабатывая исключения и отображая пользовательские сообщения об ошибках.

## Требования

| Компонент | Версия / примечания |
|-----------|---------------------|
| .NET SDK  | 9.0 |
| SQL Server| Любая редакция с поддержкой TCP-подключений |
| Windows   | Для запуска WPF-клиента (`net9.0-windows`) |

## Настройка окружения

1. **Клонируйте репозиторий и установите .NET 9 SDK.**
2. **Настройте базу данных:**
   - Измените строку подключения `ConnectionStrings:DefaultConnection` при необходимости.
   - Убедитесь, что аккаунт запуска API имеет права на создание/изменение схемы — миграции применяются автоматически при старте.
3. **Настройте JWT:** заполните `Jwt:AuthToken`, `Issuer`, `Audience` и, при необходимости, срок жизни токена. Значение `AuthToken` должно быть закодировано в Base64; опции проходят валидацию при запуске. Если AuthToken не указать - он создаётся автоматически при первом запуске и записывается в конфиг.
4. **Каталог документов:** настройте `OrderDocuments:RootPath` и список разрешённых расширений файлов. Убедитесь, что у процесса есть права на запись в каталог контента приложения.
5. **Клиентские настройки:** укажите URL API и параметры отладочного входа в `Finsight.Client/App.config`. В релизной версии оставьте `debugLoginEnabled` выключенным.

## Запуск

1) Finsight.WebAPI - запускаем серверную часть.
При старте автоматически применяются миграции EF Core, а в профиле Development доступен Swagger UI и логирование NLog (`Logs/`).

2) Finsight.Client - запускаем клиента. Запуск возможен только на Windows.

Приложение открывает окно авторизации, после чего отображает главное окно с модулями. При первом запуске нужно придумать логин и пароль для аккаунта с правами администратора - он создастся автоматически при первом запуске приложения (при отсутствии пользователей в БД).